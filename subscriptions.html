<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <title>Hedgehog Subscriptions</title>
        <script src="file:///home/supertestnet/bitcoin_projects/testnet_generator/qrcode.js"></script>
        <script src="https://supertestnet.github.io/bankify/super_nostr.js"></script>
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <script src="https://bundle.run/bech32@2.0.0"></script>
        <script>
            var hedgehog_subscriptions = {
                subscription_string: null,
                // nostr_relays: [ "wss://relay.nuts.cash/" ],
                nostr_relays: [ "ws://127.0.0.1:6969" ],
                nostr_privkey: null,
                nostr_pubkey: null,
                nostr_nprofile: null,
                checks_available: {},
                two_way_comms: {},
                use_rest: "unknown",
                rest_endpoint: "unknown",
                waitSomeTime: num => new Promise( resolve => setTimeout( resolve, num ) ),
                hexToBytes: hex => Uint8Array.from( hex.match( /.{1,2}/g ).map( byte => parseInt( byte, 16 ) ) ),
                bytesToHex: bytes => bytes.reduce( ( str, byte ) => str + byte.toString( 16 ).padStart( 2, "0" ), "" ),
                hexToText: hex => decodeURIComponent( hex.replace( /\s+/g, "" ).replace( /[0-9a-f]{2}/g, "%$&" ) ),
                textToHex: text => {
                    var encoded = new TextEncoder().encode( text );
                    return Array.from( encoded )
                        .map( x => x.toString( 16 ).padStart( 2, "0" ) )
                        .join( "" );
                },
                sha256: async s => {
                    if ( typeof s == "string" ) s = new TextEncoder().encode( s );
                    var arr = await crypto.subtle.digest( 'SHA-256', s );
                    return hedgehog_subscriptions.bytesToHex( new Uint8Array( arr ) );
                },
                createQR: content => {
                    var dataUriPngImage = document.createElement( "img" ),
                    s = QRCode.generatePNG( content, {
                        ecclevel: "M",
                        format: "html",
                        fillcolor: "#FFFFFF",
                        textcolor: "#000000",
                        margin: 4,
                        modulesize: 8,
                    });
                    dataUriPngImage.src = s;
                    dataUriPngImage.className = "qr_code";
                    dataUriPngImage.style.width = "100%";
                    return dataUriPngImage;
                },
                convertNEvent: nevent => {
                    var arr = bech32.bech32.fromWords( bech32.bech32.decode( nevent, 100_000 ).words );
                    var hex = hedgehog_subscriptions.bytesToHex( arr );
                    if ( !hex.startsWith( "0020" ) ) var event_id = hex.substring( hex.length - 64 );
                    else var event_id = hex.substring( 4, 68 );
                    if ( !hex.startsWith( "0020" ) ) hex = hex.substring( 0, hex.length - 64 );
                    else hex = hex.substring( 68 );
                    var relays = [];
                    var kind = null;
                    var author = null;
                    var loop = () => {
                        if ( hex.startsWith( "03" ) ) {
                            var kind_hex = hex.substring( 4, 12 );
                            kind = parseInt( kind_hex, 16 );
                            hex = hex.substring( 12 );
                            loop();
                        }
                        if ( hex.startsWith( "02" ) ) {
                            author = hex.substring( 4, 68 );
                            hex = hex.substring( 68 );
                            loop();
                        }
                        if ( hex.startsWith( "01" ) ) {
                            var relay_length = parseInt( hex.substring( 2, 4 ), 16 );
                            relays.push( hedgehog_subscriptions.hexToText( hex.substring( 4, 4 + relay_length * 2 ) ) );
                            hex = hex.substring( 4 + relay_length * 2 );
                            loop();
                        }
                    }
                    loop();
                    return [ event_id, relays, kind, author ];
                },
                convertPubkeyAndRelaysToNprofile: ( prefix, pubkey, relays ) => {
                    var relays_str = "";
                    relays.forEach( relay => {
                        var relay_str = hedgehog_subscriptions.textToHex( relay );
                        var len = ( relay_str.length / 2 ).toString( 16 );
                        if ( len.length % 2 ) len = "0" + len;
                        relays_str = relays_str + "01" + len + relay_str;
                    });
                    var hex = relays_str + "0020" + pubkey;
                    var bytes = hedgehog_subscriptions.hexToBytes( hex );
                    var nevent = bech32.bech32.encode( prefix, bech32.bech32.toWords( bytes ), 100_000 );
                    return nevent;
                },
                loadSubscription: async subscription_string => {
                    hedgehog_subscriptions.handleChecksLoop();
                    $( '.subscription_string' ).innerText = subscription_string;
                    subscription_string = subscription_string.substring( 3 );
                    var subscription_info = JSON.parse( hedgehog_subscriptions.hexToText( subscription_string ) );
                    var {privkey_to_reply_with, privkey} = subscription_info;
                    hedgehog_subscriptions.nostr_privkey = privkey;
                    var listenFunction = async socket => {
                        var subId = super_nostr.bytesToHex( crypto.getRandomValues( new Uint8Array( 8 ) ) );
                        var filter  = {}
                        filter.kinds = [ 16110 ];
                        filter.authors = [ super_nostr.getPubkey( privkey_to_reply_with ) ];
                        var subscription = [ "REQ", subId, filter ];
                        socket.send( JSON.stringify( subscription ) );
                    }
                    var handleFunction = async message => {
                        var [ type, subId, event ] = JSON.parse( message.data );
                        if ( !event || event === true ) return;
                        console.log( event );
                        if ( event.kind === 16110 ) {
                            var socket = super_nostr.sockets[ Object.keys( super_nostr.sockets )[ 0 ] ].socket;
                            var subId = super_nostr.bytesToHex( crypto.getRandomValues( new Uint8Array( 8 ) ) );
                            var filter  = {}
                            filter.kinds = [ 4 ];
                            filter.authors = [ super_nostr.getPubkey( privkey_to_reply_with ) ];
                            filter[ "#e" ] = [ event.id ];
                            var subscription = [ "REQ", subId, filter ];
                            socket.send( JSON.stringify( subscription ) );
                        }
                        if ( event.kind === 4 ) {
                            if ( event.pubkey !== super_nostr.getPubkey( privkey_to_reply_with ) ) {
                                hedgehog_subscriptions.two_way_comms[ "get_check_status_reply" ] = event;
                                return;
                            }
                            var privkey = hedgehog_subscriptions.nostr_privkey;
                            var dmsg = await super_nostr.alt_decrypt( privkey, event.pubkey, event.content );
                            var check_id = dmsg;
                            var [ check_privkey, check_relays ] = hedgehog_subscriptions.convertNEvent( check_id );
                            var privkey = check_privkey;
                            var check_pubkey = super_nostr.getPubkey( check_privkey );
                            var check_relay = check_relays[ 0 ];
                            var ids = null;
                            var authors = [ check_pubkey ];
                            var kinds = [ 16109 ];
                            var until = null;
                            var since = null;
                            var limit = 1;
                            var events = await super_nostr.getEvents( check_relay, ids, authors, kinds, until, since, limit );
                            if ( !events.length ) $( '.check_info' ).innerHTML = `Sorry, someone sent you an uncashable check.`;
                            var check = events[ 0 ];
                            check.content = await super_nostr.alt_decrypt( check_privkey, check_pubkey, check.content );
                            var json = JSON.parse( check.content );
                            hedgehog_subscriptions.checks_available[ check_id ] = {...json, check_status: "ready_to_cash"};
                        }
                    }
                    hedgehog_subscriptions.setUpRestLoop( handleFunction );
                    var relay = hedgehog_subscriptions.nostr_relays[ 0 ];
                    super_nostr.newPermanentConnection( relay, listenFunction, handleFunction );
                },
                handleChecksLoop: async () => {
                    var checks = Object.keys( hedgehog_subscriptions.checks_available );
                    if ( !checks.length ) {
                        $( '.pending_checks' ).innerHTML = `[None]`;
                        await hedgehog_subscriptions.waitSomeTime( 100 );
                        hedgehog_subscriptions.handleChecksLoop();
                        return;
                    }
                    var all_html = document.createElement( "div" );
                    var state_changed = false;
                    var i; for ( i=0; i<checks.length; i++ ) {
                        var check_id = checks[ i ];
                        var check = hedgehog_subscriptions.checks_available[ check_id ];
                        //if the timelock is over two minutes passed, look up whether check is redeemable -- if not, do not display the check
                        var now = Math.floor( Date.now() / 1000 );
                        if ( now > check.check_absolute_timelock + 120 ) {
                            //set up listener on nostr
                            var socket = super_nostr.sockets[ Object.keys( super_nostr.sockets )[ 0 ] ].socket;
                            var {check_server_id} = check;
                            var server_info = JSON.parse( hedgehog_subscriptions.hexToText( check_server_id ) );
                            var { connection_string, use_rest, rest_endpoint } = server_info;
                            hedgehog_subscriptions.use_rest = use_rest;
                            if ( use_rest ) hedgehog_subscriptions.rest_endpoint = rest_endpoint;
                            var [ server, servers_relays ] = hedgehog_subscriptions.convertNEvent( connection_string );
                            var subId = super_nostr.bytesToHex( crypto.getRandomValues( new Uint8Array( 8 ) ) );
                            var filter  = {}
                            filter.kinds = [ 4 ];
                            filter.authors = [ server ];
                            var subscription = [ "REQ", subId, filter ];
                            socket.send( JSON.stringify( subscription ) );

                            //ensure check is redeemable
                            var privkey = hedgehog_subscriptions.nostr_privkey;
                            var { check_amount: check_amnt, check_preimage, check_absolute_timelock, check_encrypted_chan_id: encrypted_chan_id, check_encryption_pubkey: encryption_pubkey, encrypted_channel_fee_data } = check;
                            var check_pmthash = await hedgehog_subscriptions.sha256( hedgehog_subscriptions.hexToBytes( check_preimage ) );
                            var server_pubkey = server;
                            var msg_for_server = JSON.stringify({
                                msg_type: "get_check_status",
                                msg_value: { encrypted_chan_id, check_pmthash, check_amnt, encryption_pubkey, check_absolute_timelock },
                            });
                            var emsg = await super_nostr.alt_encrypt( privkey, server_pubkey, msg_for_server );
                            var event = await super_nostr.prepEvent( privkey, emsg, 4, [ [ "p", server_pubkey ] ] );
                            hedgehog_subscriptions.sendEvent( event, servers_relays[ 0 ] );

                            //get the message from the server
                            var message_identifier = "get_check_status_reply";
                            delete hedgehog_subscriptions.two_way_comms[ message_identifier ];
                            var loop = async () => {
                                console.log( 'looking for status' );
                                await hedgehog_subscriptions.waitSomeTime( 100 );
                                if ( !hedgehog_subscriptions.two_way_comms.hasOwnProperty( message_identifier ) ) return loop();
                                return hedgehog_subscriptions.two_way_comms[ message_identifier ];
                            }
                            var event = await loop();
                            delete hedgehog_subscriptions.two_way_comms[ message_identifier ];

                            event.content = await super_nostr.alt_decrypt( privkey, event.pubkey, event.content );
                            var json = JSON.parse( event.content );
                            if ( json.msg_value === "irredeemable" ) {
                                delete hedgehog_subscriptions.checks_available[ check_id ];
                                state_changed = true;
                                continue;
                            }
                        }
                        var pathname = window.location.pathname.substring( 0, window.location.pathname.lastIndexOf( "/" ) + 1 ) + "ln_version.html";
                        var url = `${window.location.protocol}//${window.location.hostname}/${pathname}#check=${check_id}`;
                        var check_amount = check.check_amount;
                        var check_state = JSON.stringify({
                            amount: check_amount,
                            status: check.check_status,
                            url,
                        });
                        var prev_state = $( `.${check_id}` ) ? $( `.${check_id}` ).getAttribute( "data-check_state" ) : null;
                        if ( check_state !== prev_state ) state_changed = true;
                        var check_timelock = new Date( check.check_absolute_timelock * 1000 );
                        // check_timelock.setMinutes( check_timelock.getMinutes() - check_timelock.getTimezoneOffset() );
                        var check_tl_date = check_timelock.toLocaleDateString( "en-ca" );
                        var check_tl_time = check_timelock.toLocaleTimeString();
                        var now = Math.floor( Date.now() / 1000 );
                        if ( now < check.check_absolute_timelock ) check_status = "waiting for timelock";
                        else check_status = "ready to cash";
                        var check_html = `
                            <div>Amount: <span class="check_amount">${check_amount}</span></div>
                            <div>Timelock date: <span class="check_tl_date">${check_tl_date}</span></div>
                            <div>Timelock time: <span class="check_tl_time">${check_tl_time}</span></div>
                            <div>Status: <span class="check_status">${check_status}</span></div>
                            <div><button class="check_btn cash_this_check">Cash this check</button></div>
                            <div><button class="check_btn view_check_qr">View qr code</button></div>
                            <div><button class="check_btn view_payment_string">View payment string</button></div>
                            <div class="check_qr_code hidden"></div>
                            <div class="check_payment_string hidden">${url}</div>
                        `;
                        var div = document.createElement( "div" );
                        div.classList.add( "check" );
                        div.classList.add( check_id );
                        div.setAttribute( "data-check_id", check_id );
                        div.setAttribute( "data-check_state", check_state );
                        div.innerHTML = check_html;
                        div.getElementsByClassName( "cash_this_check" )[ 0 ].onclick = () => {
                            var check_id = e.target.parentElement.parentElement.getAttribute( "data-check_id" );
                            alert( `This button doesn't do anything yet` );
                        }
                        div.getElementsByClassName( "view_check_qr" )[ 0 ].onclick = e => {
                            var check_id = e.target.parentElement.parentElement.getAttribute( "data-check_id" );
                            var url = $( `.${check_id} .check_payment_string` ).innerText;
                            var qr = hedgehog_subscriptions.createQR( url.toUpperCase() );
                            var item = $( `.${check_id} .check_qr_code` );
                            item.innerHTML = ``;
                            item.append( qr );
                            if ( item.classList.contains( "hidden" ) ) item.classList.remove( "hidden" );
                            else item.classList.add( "hidden" );
                        }
                        div.getElementsByClassName( "view_payment_string" )[ 0 ].onclick = e => {
                            var check_id = e.target.parentElement.parentElement.getAttribute( "data-check_id" );
                            var item = $( `.${check_id} .check_payment_string` );
                            if ( item.classList.contains( "hidden" ) ) item.classList.remove( "hidden" );
                            else item.classList.add( "hidden" );
                        }
                        all_html.append( div );
                    }
                    if ( state_changed ) {
                        $( '.pending_checks' ).innerHTML = ``;
                        $( '.pending_checks' ).append( all_html );
                    }
                    await hedgehog_subscriptions.waitSomeTime( 100 );
                    hedgehog_subscriptions.handleChecksLoop();
                },
                sendEvent: async ( event, relay ) => {
                    if ( hedgehog_subscriptions.use_rest === "unknown" ) return;
                    if ( hedgehog_subscriptions.use_rest && !hedgehog_subscriptions.rest_endpoint ) return;
                    if ( !hedgehog_subscriptions.use_rest ) {
                        super_nostr.sendEvent( event, relay );
                        return;
                    }
                    fetch( hedgehog_subscriptions.rest_endpoint + "/write", {
                        method: "POST",
                        headers: {"Content-type": "application/json"},
                        body: JSON.stringify( event ),
                    });
                },
                setUpRestLoop: async handleFunction => {
                    var loop = async () => {
                        if ( hedgehog_subscriptions.use_rest === true ) return;
                        await hedgehog_subscriptions.waitSomeTime( 10 );
                        return loop();
                    }
                    await loop();
                    var loop = async handleFunction => {
                        var nostr_privkey = hedgehog_subscriptions.nostr_privkey;
                        var nostr_pubkey = super_nostr.getPubkey( nostr_privkey );
                        var sig = await nobleSecp256k1.schnorr.sign( "a".repeat( 64 ), nostr_privkey );
                        if ( !hedgehog_subscriptions.rest_endpoint ) {
                            await hedgehog_subscriptions.waitSomeTime( 1_000 );
                            return loop();
                        }
                        var data = await fetch( hedgehog_subscriptions.rest_endpoint + "/read", {
                            method: "POST",
                            headers: {
                                "Content-type": "application/json"
                            },
                            body: JSON.stringify({sig, pubkey: nostr_pubkey}),
                        });
                        var json = await data.json();
                        if ( json === "unknown error" ) return alert( 'unknown error with rest api' );
                        json.forEach( item => handleFunction({ data: JSON.stringify( [ null, null, item ] )}) );
                        await hedgehog_subscriptions.waitSomeTime( 1_000 );
                        return loop( handleFunction );
                    }
                    loop( handleFunction );
                },
            }
        </script>
        <style>
            * {
                box-sizing: border-box;
                font-size: 1.15rem;
                font-family: Arial, sans-serif;
            }
            html {
                max-width: 800px;
                padding: 3rem 1rem;
                margin: auto;
                line-height: 1.25;
                padding: 0;
            }
            body {
                margin: 3rem 1rem;
                word-wrap: break-word;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            input {
                line-height: 1.25;
                width: 100%;
                height: 1.8rem;
                font-size: 1.15rem;
                border: 1px solid grey;
            }
            .hidden {
                display: none !important;
            }
            .bold {
                font-weight: bold;
            }
            .check {
                background-color: lightgreen;
                padding: 1rem;
                border: 1px solid green;
                margin-bottom: 1rem;
            }
            .unfunded {
                background-color: lightblue;
            }
            .check_btn, .check_qr_code, .check_payment_string {
                margin-top: 1rem;
            }
            .check_qr_code {
                max-width: 15rem;
            }
            .check_payment_string {
                background-color: tan;
                padding: 1rem;
            }
            @media screen and (max-width: 600px) {
            }
        </style>
        <script>
            var $ = document.querySelector.bind( document );
            var $$ = document.querySelectorAll.bind( document );
            var url_params = new URLSearchParams( window.location.search );
            var url_keys = url_params.keys();
            var $_GET = {}
            for ( var key of url_keys ) $_GET[ key ] = url_params.get( key );
            var hash_arr = window.location.href.substring( window.location.href.indexOf( "#" ) ).split( "#" );
            hash_arr.splice( 0, 1 );
            var $_HASH = {}
            hash_arr.forEach( item => {
                var vals = item.split( "=" );
                $_HASH[ vals[ 0 ] ] = vals[ 1 ];
            });
        </script>
    </head>
    <body>
        <div class="webpage home_page">
            <h1>Hedgehog Subscriptions</h1>
            <p><button class="load_existing_subscription">Load existing subscription</button></p>
            <p><button class="make_new_subscription">Make new subscription</button></p>
        </div>
        <div class="webpage load_page hidden">
            <h1>Load subscription</h1>
            <p>Enter a subscription string</p>
            <p><input class="subscription_string_form"></p>
            <p><button class="load_subscription">Load subscription</button></p>
        </div>
        <div class="webpage make_page hidden">
            <h1>Make subscription</h1>
            <p>Enter a start date/time</p>
            <p><input class="start_date" type="datetime-local"></p>
            <p>Select an interval between payments</p>
            <select class="interval">
                <option value="0">--- Select ---</option>
                <option value="120">2 minutes</option>
                <option value="300">5 minutes</option>
                <option value="86400">1 day</option>
                <option value="1209600">2 weeks</option>
                <option value="2592000">30 days</option>
            </select> 
            <p>Enter the amount of sats you want per payment</p>
            <p><input type="number" min="330" step="1" value="1000" class="cost"></p>
            <p>(Optional) Enter the number of payments you want -- leave blank for an indefinite subscription</p>
            <p><input type="number" min="1" step="1" class="num_of_payments"></p>
            <p><button class="make_subscription">Make subscription request</button></p>
        </div>
        <div class="webpage subscription_page hidden">
            <h1>Your subscription</h1>
            <p class="bold">Subscription string (share with sender)</p>
            <p class="subscription_string"></p>
            <p class="bold">Pending cheques</p>
            <div class="pending_checks">[None]</div>
        </div>
    </body>
    <script>
        var showPage = page => {
            $$( '.webpage' ).forEach( item => item.classList.add( "hidden" ) );
            $( `.${page}` ).classList.remove( "hidden" );
        }
        if ( $_HASH[ "subscription_string" ] ) {
            var subscription_string = $_HASH[ "subscription_string" ];
            hedgehog_subscriptions.loadSubscription( subscription_string );
            showPage( 'subscription_page' );
        }
        $( '.load_existing_subscription' ).onclick = () => showPage( 'load_page' );
        $( '.make_new_subscription' ).onclick = () => showPage( 'make_page' );
        $( '.load_subscription' ).onclick = () => {
            var subscription_string = $( '.subscription_string_form' ).value;
            hedgehog_subscriptions.loadSubscription( subscription_string );
            showPage( 'subscription_page' );
        }
        $( '.make_subscription' ).onclick = () => {
            var start_time = Math.floor( new Date( $( '.start_date' ).value ).getTime() / 1000 );
            var now = Math.floor( Date.now() / 1000 );
            var interval = Number( $( '.interval' ).value );
            var cost = Number( $( '.cost' ).value );
            var num_of_payments = $( '.num_of_payments' ).value ? Number( $( '.num_of_payments' ).value ) : undefined;
            hedgehog_subscriptions.nostr_privkey = super_nostr.getPrivkey();
            hedgehog_subscriptions.nostr_pubkey = super_nostr.getPubkey( hedgehog_subscriptions.nostr_privkey );
            hedgehog_subscriptions.nostr_nprofile = hedgehog_subscriptions.convertPubkeyAndRelaysToNprofile( "nprofile", hedgehog_subscriptions.nostr_pubkey, hedgehog_subscriptions.nostr_relays );
            var subscription_request_json = {
                start_time,
                interval,
                cost,
                listener: hedgehog_subscriptions.nostr_nprofile,
                num_of_payments,
                privkey_to_reply_with: super_nostr.getPrivkey(),
                //TODO: think about what to do about this -- storing the privkey here means that if the recipient publishes a subscription request, anyone can steal the subscription payments -- but separating it from here means they need to "log in" with two pieces of info, their privkey and their subscription string
                privkey: hedgehog_subscriptions.nostr_privkey,
            }
            var subscription_string = "hs_" + hedgehog_subscriptions.textToHex( JSON.stringify( subscription_request_json ) );
            var url = window.location.protocol + "//" + window.location.hostname + window.location.pathname + `#subscription_string=${subscription_string}`;
            window.location.href = url;
            window.location.reload();
        }
    </script>
</html>
